<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Science Lab: Cloud Sync</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ============================================================
        // üî¥ IMPORTANT: REPLACE THIS SECTION WITH YOUR FIREBASE KEYS
        // ============================================================
        const firebaseConfig = {
    apiKey: "AIzaSyAGj-0VFzGfD43JYIjScNAamxQzCp9pfog",
    authDomain: "sciencelabsystem.firebaseapp.com",
    projectId: "sciencelabsystem",
    storageBucket: "sciencelabsystem.firebasestorage.app",
    messagingSenderId: "585267705698",
    appId: "1:585267705698:web:233f6264e324c4b36cde3b",
    measurementId: "G-JEN6KHS4YK"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
            
            // Expose to window for the main script to use
            window.db = db;
            window.collection = collection;
            window.addDoc = addDoc;
            window.query = query;
            window.orderBy = orderBy;
            window.onSnapshot = onSnapshot;
            window.serverTimestamp = serverTimestamp;
            
            console.log("Firebase Loaded");
            window.dispatchEvent(new Event('firebase-ready'));
        } catch (e) {
            console.error("Firebase Error:", e);
            alert("Error connecting to database. Check your API Keys in the code.");
        }
    </script>

    <style>
        :root { --primary: #4a6fa5; --bg: #f0f2f5; --text: #333; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        
        /* Navigation */
        nav { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .nav-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; cursor: pointer; border-radius: 4px; font-size: 14px; }
        
        /* Views */
        .view-section { display: none; height: calc(100vh - 60px); overflow-y: auto; padding: 20px; }
        .view-section.active { display: block; }
        
        /* Landing & Success */
        .center-box { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; gap: 20px; }
        .role-card { background: white; padding: 40px; border-radius: 15px; cursor: pointer; width: 280px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .role-card:active { transform: scale(0.98); }
        
        /* Simulation Area */
        .sim-wrapper { max-width: 1000px; margin: 0 auto; }
        .sim-header { margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
        .sim-container { display: flex; flex-direction: column; gap: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        @media (min-width: 768px) {
            .sim-container { flex-direction: row; }
        }

        .simulation-area { flex: 3; border: 2px dashed #e0e0e0; border-radius: 8px; position: relative; padding: 20px; min-height: 400px; background: #fafafa; }
        .palette-area { flex: 1; background: #f1f5f9; padding: 15px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; }
        
        /* Cylinders */
        .cylinders-container { display: flex; align-items: flex-end; justify-content: space-around; height: 250px; margin-bottom: 20px; pointer-events: none; /* Let particles pass through */ }
        .cylinder { width: 60px; height: 180px; border: 3px solid #555; border-top: none; position: relative; background: rgba(255,255,255,0.5); }
        
        /* Particles */
        .particle { width: 30px; height: 30px; border-radius: 50%; position: absolute; cursor: grab; z-index: 100; border: 1px solid rgba(0,0,0,0.2); touch-action: none; /* Critical for iPad */ }
        .p-water { background: #4FC3F7; box-shadow: inset -2px -2px 5px rgba(0,0,0,0.2); }
        .p-alcohol { background: #FFD54F; box-shadow: inset -2px -2px 5px rgba(0,0,0,0.2); }
        
        /* Static particles in palette */
        .static-p-wrapper { margin: 15px 0; text-align: center; }
        .static { position: relative; display: inline-block; margin-bottom: 5px; cursor: pointer; }
        
        /* Dashboard Grid */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); animation: fadeIn 0.5s; }
        .card img { width: 100%; height: 140px; object-fit: cover; object-position: top; border-bottom: 1px solid #eee; }
        .card-body { padding: 12px; }
        @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }

        /* Buttons & Inputs */
        input[type="text"], input[type="password"] { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; width: 100%; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; font-size: 16px; transition: opacity 0.2s; }
        .btn:active { opacity: 0.8; }
        .btn-blue { background: var(--primary); }
        .btn-green { background: #2e7d32; }
        .btn-red { background: #c62828; }

        /* Modal */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; z-index: 2000; }
        .modal.open { display: flex; }
        .modal-content { background: white; padding: 25px; width: 90%; max-width: 600px; border-radius: 12px; text-align: center; }
        .modal img { max-width: 100%; border: 1px solid #ddd; border-radius: 4px; margin: 15px 0; max-height: 60vh; object-fit: contain; }

    </style>
</head>
<body>

    <nav>
        <div style="font-weight:bold; font-size:1.2rem;">üß™ Cloud Lab</div>
        <button class="nav-btn" onclick="goHome()">Home</button>
    </nav>

    <!-- 1. LANDING PAGE -->
    <div id="view-landing" class="view-section active">
        <div class="center-box">
            <h1>Select Role</h1>
            <div style="display:flex; gap:20px; flex-wrap:wrap; justify-content:center;">
                <div class="role-card" onclick="showView('student')">
                    <div style="font-size:40px;">üéì</div>
                    <h2>Student</h2>
                    <p>Create & Submit</p>
                </div>
                <div class="role-card" onclick="promptTeacherPassword()">
                    <div style="font-size:40px;">üë®‚Äçüè´</div>
                    <h2>Teacher</h2>
                    <p>View Submissions</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. STUDENT SIMULATION -->
    <div id="view-student" class="view-section">
        <div class="sim-wrapper">
            <div class="sim-header">
                <input type="text" id="studentName" placeholder="Enter your full name" style="flex:1;">
                <button class="btn btn-green" onclick="submitToCloud()">Submit Work</button>
            </div>

            <!-- Area to be captured -->
            <div id="capture-area" style="background:white; padding:10px; border-radius:8px;">
                <div class="sim-container" id="drop-zone">
                    <div class="simulation-area">
                        <div class="cylinders-container">
                            <div><div class="cylinder"></div><div style="text-align:center; font-size:12px;">Water</div></div>
                            <div style="font-size:24px; align-self:center">+</div>
                            <div><div class="cylinder"></div><div style="text-align:center; font-size:12px;">Alcohol</div></div>
                            <div style="font-size:24px; align-self:center">‚û°</div>
                            <div><div class="cylinder"></div><div style="text-align:center; font-size:12px;">Mixture</div></div>
                        </div>
                        <textarea id="justification" style="width:100%; height:80px; padding:10px; border:1px solid #ccc; border-radius:4px;" placeholder="Explain: Why is the volume different?"></textarea>
                    </div>
                    
                    <!-- Palette -->
                    <div class="palette-area">
                        <p style="margin-top:0; font-weight:bold; color:#666;">Particles</p>
                        
                        <div class="static-p-wrapper">
                            <div class="particle p-water static" onmousedown="spawn(event, 'water')" ontouchstart="spawn(event, 'water')"></div>
                            <div>Water</div>
                        </div>
                        
                        <div class="static-p-wrapper">
                            <div class="particle p-alcohol static" onmousedown="spawn(event, 'alcohol')" ontouchstart="spawn(event, 'alcohol')"></div>
                            <div>Alcohol</div>
                        </div>

                        <button class="btn btn-red" style="margin-top:auto; width:100%; font-size:14px;" onclick="resetBoard()">Reset</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. SUCCESS PAGE -->
    <div id="view-success" class="view-section">
        <div class="center-box">
            <div style="font-size:60px; color:green;">‚úÖ</div>
            <h1>Submission Received!</h1>
            <p>Your work has been uploaded to the teacher's dashboard.</p>
            <button class="btn btn-blue" onclick="goHome()">Back to Home</button>
        </div>
    </div>

    <!-- 4. TEACHER DASHBOARD -->
    <div id="view-teacher" class="view-section">
        <div style="max-width:1200px; margin:0 auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>Live Class Submissions</h2>
                <span id="status-indicator" style="font-size:12px; color:green;">‚óè Live Sync Active</span>
            </div>
            <div id="submission-grid" class="grid">
                <p>Waiting for submissions...</p>
            </div>
        </div>
    </div>

    <!-- IMAGE MODAL -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title"></h3>
            <img id="modal-img" src="">
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="btn btn-blue" onclick="downloadPDF()">Download PDF</button>
                <button class="btn" style="background:#eee; color:#333" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- Navigation ---
        function showView(id) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + id).classList.add('active');
        }

        function goHome() {
            showView('landing');
        }

        function promptTeacherPassword() {
            const pass = prompt("Enter Teacher Password:");
            if(pass === "123456") {
                showView('teacher');
                initTeacherListener();
            } else if (pass !== null) {
                alert("Incorrect password.");
            }
        }

        // --- Touch & Drag Logic (iPad Compatible) ---
        const dropZone = document.getElementById('drop-zone');
        let draggedElement = null;
        let offset = { x: 0, y: 0 };

        // 1. Spawning Logic
        window.spawn = function(e, type) {
            // Prevent default to stop scrolling/zooming on iPad
            if(e.cancelable) e.preventDefault();
            
            // Get coordinates (Touch or Mouse)
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            // Create new particle
            const p = document.createElement('div');
            p.className = `particle p-${type}`;
            dropZone.appendChild(p);
            
            // Position it exactly where the finger/mouse is
            const parentRect = dropZone.getBoundingClientRect();
            p.style.left = (clientX - parentRect.left - 15) + 'px';
            p.style.top = (clientY - parentRect.top - 15) + 'px';
            
            // Immediately start dragging the new particle
            startDrag(p, clientX, clientY);
        }

        // 2. Generic Start Drag
        function startDrag(element, clientX, clientY) {
            draggedElement = element;
            const rect = draggedElement.getBoundingClientRect();
            offset.x = clientX - rect.left;
            offset.y = clientY - rect.top;

            // Add global listeners
            window.addEventListener('mousemove', handleMove);
            window.addEventListener('mouseup', handleEnd);
            window.addEventListener('touchmove', handleMove, { passive: false });
            window.addEventListener('touchend', handleEnd);
        }

        // 3. Handle Existing Particles
        dropZone.addEventListener('mousedown', e => {
            if(e.target.classList.contains('particle') && !e.target.classList.contains('static')) {
                startDrag(e.target, e.clientX, e.clientY);
            }
        });
        dropZone.addEventListener('touchstart', e => {
            if(e.target.classList.contains('particle') && !e.target.classList.contains('static')) {
                e.preventDefault(); // Stop iPad scroll
                startDrag(e.target, e.touches[0].clientX, e.touches[0].clientY);
            }
        }, { passive: false });

        // 4. Move Logic
        function handleMove(e) {
            if(!draggedElement) return;
            if(e.cancelable) e.preventDefault(); // Critical for iPad

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const parentRect = dropZone.getBoundingClientRect();
            
            // Calculate new position relative to container
            let newX = clientX - parentRect.left - offset.x;
            let newY = clientY - parentRect.top - offset.y;

            // Simple boundaries
            if(newX < 0) newX = 0;
            if(newY < 0) newY = 0;
            if(newX > parentRect.width - 30) newX = parentRect.width - 30;
            if(newY > parentRect.height - 30) newY = parentRect.height - 30;

            draggedElement.style.left = newX + 'px';
            draggedElement.style.top = newY + 'px';
        }

        // 5. End Logic
        function handleEnd() {
            draggedElement = null;
            window.removeEventListener('mousemove', handleMove);
            window.removeEventListener('mouseup', handleEnd);
            window.removeEventListener('touchmove', handleMove);
            window.removeEventListener('touchend', handleEnd);
        }

        window.resetBoard = function() {
            document.querySelectorAll('.particle:not(.static)').forEach(el => el.remove());
            document.getElementById('justification').value = '';
        }

        // --- FIREBASE LOGIC ---

        // 1. Submit (Student)
        window.submitToCloud = async function() {
            if(!window.db) { alert("Database not connected. Did you paste your API keys?"); return; }
            
            const name = document.getElementById('studentName').value.trim();
            if(!name) return alert("Please enter your name first.");

            const btn = document.querySelector('.btn-green');
            btn.innerText = "Sending...";
            btn.disabled = true;

            try {
                // Capture Screenshot - Lower scale for smaller file size (faster sync)
                const canvas = await html2canvas(document.getElementById('capture-area'), {
                    scale: 1, 
                    useCORS: true,
                    backgroundColor: "#ffffff"
                });
                
                // Compress to JPEG 0.7 quality
                const imgData = canvas.toDataURL('image/jpeg', 0.7);

                // Upload
                await window.addDoc(window.collection(window.db, "submissions"), {
                    name: name,
                    image: imgData,
                    createdAt: window.serverTimestamp()
                });

                // Success!
                resetBoard();
                document.getElementById('studentName').value = '';
                showView('success');

            } catch (e) {
                console.error(e);
                alert("Upload failed: " + e.message);
            } finally {
                btn.innerText = "Submit Work";
                btn.disabled = false;
            }
        }

        // 2. Listen (Teacher)
        let unsubscribe = null;
        let submissionsData = [];

        function initTeacherListener() {
            if(unsubscribe) return; // Prevent double listeners
            if(!window.db) return;

            const q = window.query(window.collection(window.db, "submissions"), window.orderBy("createdAt", "desc"));
            
            // Real-time listener
            unsubscribe = window.onSnapshot(q, (snapshot) => {
                const grid = document.getElementById('submission-grid');
                grid.innerHTML = '';
                submissionsData = [];

                if(snapshot.empty) {
                    grid.innerHTML = '<p>No submissions yet.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    submissionsData.push({id: doc.id, ...data});

                    const div = document.createElement('div');
                    div.className = 'card';
                    div.innerHTML = `
                        <img src="${data.image}" loading="lazy">
                        <div class="card-body">
                            <strong>${data.name}</strong>
                            <div style="margin-top:5px; font-size:12px; color:#666;">
                                ${data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleTimeString() : 'Just now'}
                            </div>
                            <button class="btn btn-blue" style="margin-top:10px; font-size:12px; padding:5px 10px;" onclick="openModal('${doc.id}')">View Full</button>
                        </div>
                    `;
                    grid.appendChild(div);
                });
            }, (error) => {
                console.error("Listener Error:", error);
                alert("Error fetching data. Check console.");
            });
        }

        // --- Modal & PDF ---
        let currentImg = null;
        let currentName = null;

        window.openModal = (id) => {
            const sub = submissionsData.find(s => s.id === id);
            if(!sub) return;
            currentImg = sub.image;
            currentName = sub.name;
            document.getElementById('modal-title').innerText = sub.name;
            document.getElementById('modal-img').src = sub.image;
            document.getElementById('modal').classList.add('open');
        }

        window.closeModal = () => {
            document.getElementById('modal').classList.remove('open');
        }

        window.downloadPDF = () => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('l', 'mm', 'a4');
            const width = pdf.internal.pageSize.getWidth();
            const props = pdf.getImageProperties(currentImg);
            const h = (props.height * (width-20)) / props.width;
            
            pdf.text(`Student: ${currentName}`, 10, 10);
            pdf.addImage(currentImg, 'JPEG', 10, 20, width-20, h);
            pdf.save(`${currentName}_Lab_Report.pdf`);
        }
    </script>
</body>
</html>