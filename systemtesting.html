<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Science Lab: Online System</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.min.js"></script>

    <!-- Firebase SDKs (The Backend) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- 1. PASTE YOUR FIREBASE CONFIG HERE ---
        // Replace the values below with the ones from your Firebase Console
        const firebaseConfig = {
            apiKey: "AIzaSyD-YOUR_API_KEY_HERE",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456:web:abcdef"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make functions available globally
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.query = query;
        window.orderBy = orderBy;
        window.onSnapshot = onSnapshot;
        window.serverTimestamp = serverTimestamp;
        
        // Signal that Firebase is ready
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <style>
        /* CSS Styles - Same as before for consistency */
        :root { --primary: #4a6fa5; --bg: #f0f2f5; --text: #333; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); color: var(--text); display: flex; flex-direction: column; height: 100vh; }
        nav { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .nav-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; cursor: pointer; border-radius: 4px; }
        .view-section { display: none; height: 100%; overflow-y: auto; }
        .view-section.active { display: block; }
        
        /* Landing */
        .landing { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80vh; gap: 20px; }
        .role-card { background: white; padding: 30px; border-radius: 10px; cursor: pointer; text-align: center; width: 250px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .role-card:hover { transform: translateY(-5px); }
        
        /* Simulation */
        .sim-wrapper { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .sim-container { display: flex; gap: 20px; background: white; padding: 20px; border-radius: 8px; min-height: 500px; }
        .simulation-area { flex: 3; border: 1px dashed #ccc; position: relative; padding: 20px; }
        .palette-area { flex: 1; background: #f8f9fa; padding: 15px; }
        
        .cylinders-container { display: flex; align-items: flex-end; justify-content: space-around; height: 300px; margin-bottom: 20px; }
        .cylinder { width: 70px; height: 200px; border: 4px solid #333; border-top: none; position: relative; }
        .particle { width: 25px; height: 25px; border-radius: 50%; position: absolute; cursor: grab; z-index: 100; border: 1px solid #000; }
        .p-water { background: #87CEEB; }
        .p-alcohol { background: #F4D03F; }
        .static { position: relative; display: inline-block; margin: 5px; }
        
        /* Dashboard */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding: 20px; }
        .card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card img { width: 100%; height: 150px; object-fit: cover; object-position: top; }
        .card-body { padding: 15px; }
        .btn { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; color: white; }
        .btn-blue { background: var(--primary); }
        .btn-green { background: #2e7d32; }
        
        /* Modal */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 1000; }
        .modal.open { display: flex; }
        .modal-content { background: white; padding: 20px; max-width: 90%; max-height: 90%; overflow: auto; border-radius: 8px; }
        .modal img { max-width: 100%; border: 1px solid #ccc; }
    </style>
</head>
<body>

    <nav>
        <div style="font-weight:bold; font-size:1.2rem;">üß™ ScienceLab Cloud</div>
        <button class="nav-btn" onclick="showView('landing')">Home</button>
    </nav>

    <!-- LANDING -->
    <div id="view-landing" class="view-section active">
        <div class="landing">
            <h1>Select Your Role</h1>
            <div style="display:flex; gap:20px;">
                <div class="role-card" onclick="showView('student')">
                    <h2>üéì Student</h2>
                    <p>Do simulation & Submit</p>
                </div>
                <div class="role-card" onclick="showView('teacher')">
                    <h2>üë®‚Äçüè´ Teacher</h2>
                    <p>View Live Submissions</p>
                </div>
            </div>
        </div>
    </div>

    <!-- STUDENT VIEW -->
    <div id="view-student" class="view-section">
        <div class="sim-wrapper">
            <div style="margin-bottom: 20px; display:flex; gap:10px;">
                <input type="text" id="studentName" placeholder="Enter your full name" style="padding:10px; width:250px;">
                <button class="btn btn-green" onclick="submitToCloud()">Submit to Teacher</button>
            </div>

            <div id="capture-area">
                <div class="sim-container" id="drop-zone">
                    <div class="simulation-area">
                        <div class="cylinders-container">
                            <div><div class="cylinder"></div><div style="text-align:center">Water</div></div>
                            <div style="font-size:30px; align-self:center">+</div>
                            <div><div class="cylinder"></div><div style="text-align:center">Alcohol</div></div>
                            <div style="font-size:30px; align-self:center">‚û°</div>
                            <div><div class="cylinder"></div><div style="text-align:center">Mixture</div></div>
                        </div>
                        <textarea id="justification" style="width:100%; height:60px;" placeholder="Explain your model here..."></textarea>
                    </div>
                    <div class="palette-area">
                        <p>Drag particles:</p>
                        <div class="particle p-water static" onmousedown="spawn(event, 'water')"></div> Water
                        <br>
                        <div class="particle p-alcohol static" onmousedown="spawn(event, 'alcohol')"></div> Alcohol
                        <button class="btn btn-blue" style="margin-top:20px; width:100%" onclick="resetBoard()">Reset</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TEACHER VIEW -->
    <div id="view-teacher" class="view-section">
        <div style="padding:20px;">
            <h2>Live Student Submissions</h2>
            <p id="loading-text">Connecting to database...</p>
            <div id="submission-grid" class="grid"></div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title"></h3>
            <img id="modal-img" src="">
            <div style="margin-top:10px; text-align:right;">
                <button class="btn btn-blue" onclick="downloadPDF()">Download PDF</button>
                <button class="btn" style="background:#ccc; color:black" onclick="document.getElementById('modal').classList.remove('open')">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- Navigation ---
        function showView(id) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + id).classList.add('active');
            if(id === 'teacher') initTeacherListener();
        }

        // --- Simulation Logic (Drag & Drop) ---
        const dropZone = document.getElementById('drop-zone');
        let dragged = null, offsetX=0, offsetY=0;

        function spawn(e, type) {
            e.preventDefault();
            const p = document.createElement('div');
            p.className = `particle p-${type}`;
            dropZone.appendChild(p);
            
            const rect = p.getBoundingClientRect();
            const parent = dropZone.getBoundingClientRect();
            p.style.left = (e.clientX - parent.left - 12) + 'px';
            p.style.top = (e.clientY - parent.top - 12) + 'px';
            
            dragged = p;
            offsetX = 12; offsetY = 12;
            window.addEventListener('mousemove', onMove);
            window.addEventListener('mouseup', onEnd);
        }

        dropZone.addEventListener('mousedown', e => {
            if(e.target.classList.contains('particle') && !e.target.classList.contains('static')) {
                dragged = e.target;
                const r = dragged.getBoundingClientRect();
                offsetX = e.clientX - r.left;
                offsetY = e.clientY - r.top;
                window.addEventListener('mousemove', onMove);
                window.addEventListener('mouseup', onEnd);
            }
        });

        function onMove(e) {
            if(!dragged) return;
            const parent = dropZone.getBoundingClientRect();
            dragged.style.left = (e.clientX - parent.left - offsetX) + 'px';
            dragged.style.top = (e.clientY - parent.top - offsetY) + 'px';
        }

        function onEnd() {
            dragged = null;
            window.removeEventListener('mousemove', onMove);
            window.removeEventListener('mouseup', onEnd);
        }

        function resetBoard() {
            document.querySelectorAll('.particle:not(.static)').forEach(el => el.remove());
            document.getElementById('justification').value = '';
        }

        // --- FIREBASE LOGIC ---

        // 1. Submit to Cloud (Student)
        async function submitToCloud() {
            if(!window.db) { alert("Database not ready yet. Check your config."); return; }
            
            const name = document.getElementById('studentName').value;
            if(!name) return alert("Please enter name");

            // Capture Screenshot
            const canvas = await html2canvas(document.getElementById('capture-area'), {scale:1.5});
            const imgData = canvas.toDataURL('image/png'); // Convert to Base64 string

            try {
                // Upload to Firestore
                await window.addDoc(window.collection(window.db, "submissions"), {
                    name: name,
                    image: imgData,
                    createdAt: window.serverTimestamp() // Server time
                });
                alert("Sent to teacher successfully!");
                resetBoard();
                document.getElementById('studentName').value = '';
                showView('landing');
            } catch (e) {
                console.error(e);
                alert("Error sending: " + e.message);
            }
        }

        // 2. Listen for Data (Teacher)
        let unsubscribe = null;
        let submissionsData = [];

        function initTeacherListener() {
            if(unsubscribe) return; // Already listening
            if(!window.db) return;

            const q = window.query(window.collection(window.db, "submissions"), window.orderBy("createdAt", "desc"));
            
            // onSnapshot runs every time the database changes!
            unsubscribe = window.onSnapshot(q, (snapshot) => {
                const grid = document.getElementById('submission-grid');
                document.getElementById('loading-text').style.display = 'none';
                grid.innerHTML = '';
                submissionsData = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    submissionsData.push({id, ...data});

                    const div = document.createElement('div');
                    div.className = 'card';
                    div.innerHTML = `
                        <img src="${data.image}">
                        <div class="card-body">
                            <strong>${data.name}</strong>
                            <div style="margin-top:10px;">
                                <button class="btn btn-blue" onclick="openModal('${id}')">View</button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(div);
                });
            });
        }

        // Wait for Firebase to load before attaching listeners
        window.addEventListener('firebase-ready', () => {
            console.log("Firebase initialized");
        });

        // --- Viewer Logic ---
        let currentImg = null;
        let currentName = null;

        window.openModal = (id) => {
            const sub = submissionsData.find(s => s.id === id);
            if(!sub) return;
            
            currentImg = sub.image;
            currentName = sub.name;
            
            document.getElementById('modal-title').innerText = sub.name;
            document.getElementById('modal-img').src = sub.image;
            document.getElementById('modal').classList.add('open');
        }

        window.downloadPDF = () => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('l', 'mm', 'a4');
            const width = pdf.internal.pageSize.getWidth();
            const props = pdf.getImageProperties(currentImg);
            const h = (props.height * (width-20)) / props.width;
            
            pdf.text(`Student: ${currentName}`, 10, 10);
            pdf.addImage(currentImg, 'PNG', 10, 20, width-20, h);
            pdf.save(`${currentName}_work.pdf`);
        }
    </script>
</body>
</html>